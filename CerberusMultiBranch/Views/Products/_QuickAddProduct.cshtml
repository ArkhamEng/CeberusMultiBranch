@model CerberusMultiBranch.Models.ViewModels.Catalog.ProductViewModel
@using CerberusMultiBranch.Support

@section Scripts
{
    @Scripts.Render("~/bundles/jqueryval")
}
<script src="~/Scripts/jquery.validate.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>



<form id="mForm">
    <div id="ModalQuickAddProduct" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content panel panel-primary panel-group">
                <div class="modal-header panel-heading">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">
                        <span class="fa fa-archive"></span>
                        Edición de Producto
                    </h4>
                </div>
                <div class="modal-body panel-body panel-group row">

                    <ul class="nav nav-tabs">
                        <li class="active">
                            <a data-toggle="tab" href="#general">
                                <span class="fa fa-columns"></span>
                                Detalle
                            </a>
                        </li>

                        @if (Model.ProductId > Cons.Zero)
                        {
                            <li>
                                <a data-toggle="tab" href="#models">
                                    <span class="fa fa-car"></span> Autos
                                    <span class="bg-danger badge">
                                        @Model.Compatibilities.Count
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a data-toggle="tab" href="#images">
                                    <span class="fa fa-image"></span> Imagenes
                                    <span class="bg-danger badge">
                                        @Model.Images.Count
                                    </span>
                                </a>
                            </li>
                        }

                        @if (Model.ProductType == CerberusMultiBranch.Models.Entities.Catalog.ProductType.Package)
                        {
                            <li><a data-toggle="tab" href="#detail">Productos del paquete </a></li>
                        }
                    </ul>

                    <div class="tab-content">
                        <div id="general" class="tab-pane fade in active">
                            @Html.Partial("_GeneralData",Model)
                        </div>

                        <div id="detail" class="tab-pane fade">
                            <div id="divPackageDetails">
                                @Html.Partial("_PackageDetails", Model.PackageDetails)
                            </div>
                        </div>

                        <div id="models" class="tab-pane fade">
                            <div>
                                @Html.Partial("_CarModelSelector", Model)
                            </div>
                        </div>
                        <div id="images" class="tab-pane fade">
                            <div>
                                <div class="col-md-12" id="divImages" style="align-items:center">
                                    @Html.Partial("_ImagesLoaded", Model.Images)
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-success" id="btnQuickSave" onclick="Send()" type="button">
                        <span class="glyphicon glyphicon-floppy-disk"></span>
                        <u>G</u>uardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" id="exCode" />
    <input type="hidden" id="ProviderId" />
</form>

<script>
    $(document).ready(function () {
        SetCascade("#PartSystemId", "#CategoryId", 'GetCategories');

        var form = $("#mForm");
        form.validate();

        $("#StorePercentage").keyup(SetPrice);
        $("#StorePercentage").click(SetPrice);

        $("#WholesalerPercentage").keyup(SetPrice);
        $("#WholesalerPercentage").click(SetPrice);

        $("#DealerPercentage").keyup(SetPrice);
        $("#DealerPercentage").click(SetPrice);

        $("#BuyPrice").keyup(SetPrice);
        $("#BuyPrice").click(SetPrice);

    }).keydown(function (e)
    {
        if ($("#ModalQuickAddProduct").hasClass('in'))
        {
            if (e.keyCode == 13 || (e.altKey && e.keyCode == 71))
            {
                e.preventDefault();
                e.stopImmediatePropagation();
                $("#btnQuickSave").click();
            }
        }
    });

    function SetPrice() {
        var sp = (1 + $("#StorePercentage").val() / 100);
        var dp = (1 + $("#WholesalerPercentage").val() / 100);
        var wp = (1 + $("#DealerPercentage").val() / 100);

        $("#StorePrice").val(($("#BuyPrice").val() * sp).toFixed(0));
        $("#WholesalerPrice").val(($("#BuyPrice").val() * dp).toFixed(0));
        $("#DealerPrice").val(($("#BuyPrice").val() * wp).toFixed(0));
    }

    function Send(providerId, code) {
        $("lblQuickAddError").text("");
        var form = $("#mForm");

        if (!form.valid())
            return;

        var product =
        {
            Code: $("#Code").val(), CategoryId: $("#CategoryId").val(), TradeMark: $("#TradeMark").val(), Name: $("#Name").val(), PartSystemId: $("#PartSystemId").val(),
            WholesalerPrice: $("#WholesalerPrice").val(), DealerPrice: $("#DealerPrice").val(), BuyPrice: $("#BuyPrice").val(),
            StorePrice: $("#StorePrice").val(), Unit: $("#Unit").val(), DealerPercentage: $("#DealerPercentage").val(),
            WholesalerPercentage: $("#WholesalerPercentage").val(), StorePercentage: $("#StorePercentage").val(),
            ProductId: $("#ProductId").val(), Quantity: $("#Quantity").val(), IsActive: $("#IsActive").val()
        };
        console.log(product);
        $("#ModalQuickAddProduct").on('hidden.bs.modal', function () {
            LookFor();
        });

        if (product.ProductId == 0) {
            var param = {
                product: product, providerId: $("#ProviderId").val(),
                code: $("#Code").val()
            };


            ExecuteAjax('@Url.Action("Copy","Products")', param, function (response) {
                if (response.Result != 'OK') {
                    $("lblQuickAddError").text(response.Message);
                }
                else {
                    $("#ModalQuickAddProduct").modal('hide');
                    $("#txtName").val(response.Code);
                }
            });
        }
        else {
            var param = {
                product: product
            };


            ExecuteAjax('@Url.Action("QuickSave","Products")', param, function (response) {
                if (response.Result != 'OK') {
                    $("lblQuickAddError").text(response.Message);
                }
                else {
                    $("#ModalQuickAddProduct").modal('hide');
                    $("#txtName").val(response.Code);
                }
            });
        }
    }


    function Copy() {
        $("#imgProd").attr("class", "img-responsive");
        $("#divProd").hide();

        var param =
        {
            Code: $("#Code").val(), CategoryId: $("#CategoryId").val(), TradeMark: $("#TradeMark").val(), Name: $("#Name").val(), PartSystemId: $("#SystemId").val(),
            WholesalerPrice: $("#WholesalerPrice").val(), DealerPrice: $("#DealerPrice").val(), BuyPrice: $("#BuyPrice").val(),
            StorePrice: $("#StorePrice").val(), Unit: $("#Unit").val()
        }

        ExecuteAjax('@Url.Action("Copy")', { product: param, providerId: $("#ProviderId").val(), code: $("#ExCode").val() }, function (j) {
            if (j.Result != "OK") {
                $("#imgProd").attr("class", "img-responsive hide");
                $("#lblMessage").text(j.Result + '==>' + j.Message);
                $("#divProd").show();
            }
            else {
                $("#ModalCloneProduct").modal("hide");
            }
        });
    }
</script>
