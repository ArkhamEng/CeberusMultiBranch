@model CerberusMultiBranch.Models.Entities.Operative.Sale

@{
    ViewBag.Title = "Carrito";
}

@Scripts.Render("~/bundles/jqueryval")
<script>
    HalfProgress();
</script>

<h3>
    <span class="fa fa-shopping-cart" style="float:left"></span>
    &nbsp;&nbsp;Carrito de Venta
</h3>



@using (Html.BeginForm("ShopingCart", "Sales"))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @Html.HiddenFor(m => m.BranchId)
    @Html.HiddenFor(m => m.TransactionId)
    @Html.HiddenFor(m => m.UserId)
    @Html.HiddenFor(m => m.IsPayed)
    @Html.HiddenFor(m => m.EmployeeId)
    @Html.HiddenFor(m => m.ClientId)

    <h4 id="hClientName" class="text-danger"></h4>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" href="#Filters">Filtros de Busqueda</a>
            </h4>
        </div>

        <div id="Filters" class="panel-collapse collapse">
            <div class="panel-body">
                <div class="row">
                    <div class="form-group col-md-4">
                        @Html.Label("Categoría", htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                            @Html.DropDownList("CategoryId", Model.Categories, "", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="col-md-8">
                        @Html.Label("Nombre o Clave", htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                            @Html.TextBox("ProductName", "", htmlAttributes: new { @class = "form-control" })
                            <span class="input-group-btn">
                                <button id="btnQuickProduct" type="button" class="btn btn-default">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                                <button id="btnAddProduct" type="button" class="btn btn-warning" onclick="window.open('@Url.Action("Create","Products")','blank')">
                                    <span class="glyphicon glyphicon-plus"></span>
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="form-group col-md-4">
                        @Html.Label("Marca", htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                            @Html.DropDownList("CarMakeId", Model.CarMakes, "", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        @Html.Label("Modelo", htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                            @Html.DropDownList("CarModelId", Model.CarModels, "", new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group col-md-4">
                        @Html.Label("Año", htmlAttributes: new { @class = "control-label" })
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-filter"></i></span>
                            @Html.DropDownList("CarYearId", Model.CarYear, "", new { @class = "form-control" })
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    if (Model.TransactionDetails.Count > 0)
    {
        <div class="panel panel-danger col-md-12">
            <div id="divDetails" class="panel-body">
                @Html.Partial("_Details", Model.TransactionDetails)
            </div>
        </div>
    }
    else
    {
        <div class="panel panel-danger">
            <div class="panel-body">
                <div class="col-md-offset-4 col-md-4">
                    <p>
                        Aun no has agregado ningun producto a la venta, has click en el boton Agregar de la parte inferior para comenzar
                    </p>
                </div>
            </div>
        </div>
    }

    <div class="panel panel-danger">
        <div class="panel-body row">
            <div class="col-md-6 btn-group">
                <button class="btn btn-warning" type="button" id="btnAddProduct">
                    <span class="fa fa-plus"></span>
                    Agregar
                </button>
                @if (Model.TransactionDetails.Count > 0)
                {
                    <button class="btn btn-primary" type="button">
                        <span class="fa fa-exchange"></span>
                        Cambio de tarifa
                    </button>

                    <button id="btnShowClients" class="btn btn-success" type="button">
                        <span class="fa fa-user-plus"></span>
                        Cargo a cliente
                    </button>

                    <button class="btn btn-danger" type="button" id="btnChoosPayment">
                        <span class="fa fa-usd"></span>
                        Realizar Pago
                    </button>
                }
            </div>
        </div>
    </div>

    @Html.Partial("_ChoosePayment")

    @Html.Partial("_QuickClient")

    @Html.Partial("_AddProduct")
}


<script>
    $(document).ready(function ()
    {

        $("#btnAddProduct").click(function ()
        {
            $("#ModalProduct").modal('show');
        });

        SetCascade("#CarMakeId", "#CarModelId", "GetModels");

        SetCascade("#CarModelId", "#CarYearId", "GetYears");

        $("#btnShowClients").click(function () {
            $("#ModalQuickClient").modal('show');
        });

        $("#btnChoosPayment").click(function () {
            ExecuteAjax('@Url.Action("CashRegStatus","CashRegister")', {}, function (data) {
                if (data == "OK") {
                    console.log(data);
                    $("#ModalPayment").modal('show');
                }
                else {
                    console.log(data);
                    ShowMessage("Error en modulo de caja!", data, "warning");
                }
            });
        });

        $("#lblTotalAmount").val(' @Html.DisplayFor(model => model.TotalAmount)')
        CompleateProgress();
    });

    function ClientSelected(id, name, ftr) {
        $("#ClientId").val(id);

        var title = "Cliente:  " + name

        if (ftr != '')
            title += "               RFC: " + ftr;

        $("#hClientName").text(title);
        $("#ModalQuickClient").modal('hide');
    }

    function Calculate(val) {
        var total = $("#lblTotalAmount").text().replace(/[$,]+/g, "");

        var result = (total - val);

        return (total - parseFloat(val));
    }

    function GetChange(val) {
        var total = $("#lblTotalAmount").text().replace(/[$,]+/g, "");


        return (parseFloat(val) - total);
    }

</script>

