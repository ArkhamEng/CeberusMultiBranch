@model CerberusMultiBranch.Models.ViewModels.Operative.SaleViewModel

@{
    ViewBag.Title = "Carrito";
}

@Scripts.Render("~/bundles/jqueryval")
<script>
    HalfProgress();
</script>

<h3>
    <span class="fa fa-shopping-cart" style="float:left"></span>
    &nbsp;&nbsp;Carrito de Venta
</h3>



@using (Html.BeginForm("Create", "Sales"))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @Html.HiddenFor(m => m.BranchId)
    @Html.HiddenFor(m => m.TransactionId)
    @Html.HiddenFor(m => m.UserId)
    @Html.HiddenFor(m => m.IsPayed)
    @Html.HiddenFor(m => m.EmployeeId)
    @Html.HiddenFor(m => m.ClientId)


    if (Model.Client != null)
    {   <h4 id="hClientName" class="text-danger">
           @Model.Client.Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RFC:&nbsp;&nbsp;@Model.Client.FTR
        </h4>
    }
    else
    {
        <h4 id="hClientName" class="text-danger">
        </h4>
    }

    @Html.Partial("_ProductSearchFilters",Model)
    

    if (Model.TransactionDetails.Count > 0)
    {
        <div class="panel panel-danger col-md-12">
            <div id="divDetails" class="row">
                @Html.Partial("_Details", Model.TransactionDetails)
            </div>
        </div>
    }
    else
    {
        <div class="panel panel-danger">
            <div class="panel-body">
                <div class="col-md-offset-3 col-md-6">
                    <p>
                        Aun no has agregado ningun producto a la venta, utiliza los filtros para buscar y agregar productos
                        o navega a traves del Catálogo.
                    </p>
                </div>
            </div>
        </div>
    }

    <div class="panel panel-danger">
        <div class="panel-body row">
            <div class="col-md-6 btn-group">
                @if (Model.TransactionDetails.Count > 0)
                {
                    <button class="btn btn-primary" type="button">
                        <span class="fa fa-exchange"></span>
                        Cambio de tarifa
                    </button>

                    <button id="btnShowClients" class="btn btn-success" type="button">
                        <span class="fa fa-user-plus"></span>
                        Cargo a cliente
                    </button>

                    <button class="btn btn-danger" type="button" id="btnChoosPayment">
                        <span class="fa fa-usd"></span>
                        Realizar Pago
                    </button>
                }
            </div>
        </div>
    </div>

    @Html.Partial("_ChoosePayment")

    @Html.Partial("_QuickClient")


    <div id="divModal"></div>
}


<script>
    $(document).ready(function ()
    {
        $("#btnAddProduct").click(function ()
        {
            HalfProgress();
            var filters = { categortyId: $("#CategoryId").val(), carYearId: $("#CarYearId").val(), name: $("#ProductName").val() }
            ExecuteAjax('@Url.Action("SearchForSale", "Products")', filters, function (view) {
                $("#divModal").html(view);
            });
        });

        SetCascade("#CarMakeId", "#CarModelId", "GetModels");

        SetCascade("#CarModelId", "#CarYearId", "GetYears");

        $("#btnShowClients").click(function () {
            $("#ModalQuickClient").modal('show');
        });

        $("#btnChoosPayment").click(function () {
            ExecuteAjax('@Url.Action("CashRegStatus","CashRegister")', {}, function (data) {
                if (data == "OK") {
                    console.log(data);
                    $("#ModalPayment").modal('show');
                }
                else {
                    console.log(data);
                    ShowMessage("Error en modulo de caja!", data, "warning");
                }
            });
        });

        $("#lblTotalAmount").val(' @Html.DisplayFor(model => model.TotalAmount)')
        CompleateProgress();
    });

    function ClientSelected(id, name, ftr)
    {
        $("#ClientId").val(id);

        var param = { clientId: id, transactionId: $("#TransactionId").val() }
        ExecuteAjax('@Url.Action("SetClient","Sales")', param, function (j) {
            $("#ModalQuickClient").modal('hide');
            if (j.Result != 'OK')
                ShowMessage(j.Result, j.Data, 'warning');
            else {
                $("#hClientName").text('');
                $("#hClientName").append(name);
                $("#hClientName").append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
                $("#hClientName").append("RFC:");
                $("#hClientName").append(ftr);
            }
        });
    }

    function Calculate(val)
    {
        var total = $("#lblTotalAmount").text().replace(/[$,]+/g, "");

        var result = (total - val);

        return (total - parseFloat(val));
    }

    function GetChange(val)
    {
        var total = $("#lblTotalAmount").text().replace(/[$,]+/g, "");
        return (parseFloat(val) - total);
    }

</script>

